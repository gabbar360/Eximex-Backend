<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Commercial Invoice</title>
    <style>
        :root {
            --outer: 2px solid #000;
            --inner: 1px solid #000;
            --grey: #e0e0e0;
        }

        body {
            font-family: Arial, sans-serif;
            font-size: 10px;
            margin: 10px;
        }

        .page {
            border: var(--outer);
        }

        .title {
            background: var(--grey);
            text-align: center;
            font-weight: 700;
            font-size: 16px;
            padding: 6px 8px;
            border-bottom: var(--inner);
        }

        .subtitle {
            text-align: center;
            padding: 6px 8px;
            border-bottom: var(--inner);
            font-size: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            border: var(--inner);
            padding: 6px;
            vertical-align: top;
        }

        .header {
            background: var(--grey);
            font-weight: bold;
        }

        .center {
            text-align: center;
        }

        .right {
            text-align: right;
        }

        .bold {
            font-weight: bold;
        }

        .table-title {
            text-align: center;
            border-left: var(--inner);
            border-right: var(--inner);
            border-bottom: var(--inner);
            background: var(--grey);
            padding: 6px 4px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="page">
        <div class="title">CUSTOM INVOICE</div>
        <div class="subtitle">SUPPLY MEANT FOR EXPORT UNDER BOND & LUT - LETTER OF UNDERTAKING WITHOUT PAYMENT OF INTEGRATED TAX</div>

        <table>
            <tr>
                <td rowspan="3" style="width: 60%;">
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <div style="flex: 1;">
                            <div class="bold" style="text-decoration: underline;">EXPORTER:</div>
                            <div class="bold" style="margin-top: 4px; font-size: 12px;">
                                <%= order?.company?.name || 'COMPANY NAME' %>
                            </div>
                            <div><%= order?.company?.address || 'Company Address' %></div>
                            <div>
                                <%= order?.company.city || '' %>
                                <%= order?.company.state ? ', ' + order?.company.state : '' %>
                                <%= order?.company.pincode ? ', ' + order?.company.pincode : '' %>
                            </div>
                            <div>Phone: <%= order?.company.phoneNo || '+91-XXXXXXXXXX' %></div>
                            <div>Email: <%= order?.company.email || 'email@company.com' %></div>
                        </div>
                        <div style="text-align:right;">
                            <% const logoUrl = order?.company?.logo; %>
                            <% const fullLogoUrl = logoUrl ? (logoUrl.startsWith('http') ? logoUrl : `http://localhost:8000${logoUrl}`) : null; %>
                            <% if (typeof logoBase64 !== 'undefined' && logoBase64) { %>
                                <img src="data:image/*;base64,<%= logoBase64 %>" alt="Company Logo" style="max-height: 80px; max-width: 200px; object-fit: contain; border-radius: 8px; border: none; padding: 4px;">
                            <% } else if (fullLogoUrl) { %>
                                <img src="<%= fullLogoUrl %>" alt="Company Logo" style="max-height: 80px; max-width: 200px; object-fit: contain; border-radius: 8px; border: none; padding: 4px;">
                            <% } %>
                        </div>
                    </div>
                </td>
                <td style="width: 20%;" class="center">
                    <div class="bold">Invoice No:</div>
                    <div class="bold" style="font-size: 12px; margin-top: 2px;">
                        <%= order?.piInvoice?.piNumber || order?.orderNumber || 'N/A' %>
                    </div>
                </td>
                <td style="width: 20%;" class="center">
                    <div class="bold">Date:</div>
                    <div class="bold" style="font-size: 12px; margin-top: 2px;">
                        <%= order?.piInvoice?.invoiceDate ? new Date(order.piInvoice.invoiceDate).toLocaleDateString('en-GB', { day:'2-digit', month:'long', year:'numeric' }) : 'N/A' %>
                    </div>
                </td>
            </tr>
            <tr>
                <td colspan="2" class="bold">Buyer's Ref No. & Date :-</td>
            </tr>
            <tr>
                <td colspan="2">
                    <div class="bold">Terms & Conditions :-</div>
                    <ol style="margin: 4px 0 0 16px; padding: 0;">
                        <% if (order?.piInvoice?.deliveryTerm || order?.deliveryTerms) { %>
                            <li>TRADE TERM: <%= (order?.piInvoice?.deliveryTerm || order?.deliveryTerms).toUpperCase() %></li>
                        <% } %>
                        <% if (order?.piInvoice?.paymentTerm || order?.paymentTerms) { %>
                            <% 
                                // Format payment term based on advance percentage and balance term
                                let formattedPaymentTerm = order?.piInvoice?.paymentTerm || order?.paymentTerms;
                                if ((order?.piInvoice?.paymentTerm === 'advance' || order?.paymentTerms === 'advance') && order?.piInvoice?.advancePercentage) {
                                    const advance = parseInt(order.piInvoice.advancePercentage);
                                    const balance = 100 - advance;
                                    if (balance > 0 && order?.piInvoice?.balancePaymentTerm) {
                                        formattedPaymentTerm = `${advance}% ADVANCE. ${balance}% ${order.piInvoice.balancePaymentTerm}`;
                                    } else {
                                        formattedPaymentTerm = `${advance}% ADVANCE`;
                                    }
                                } else {
                                    formattedPaymentTerm = formattedPaymentTerm.toUpperCase();
                                }
                            %>
                            <li>PAYMENT TERM: <%= formattedPaymentTerm %></li>
                        <% } %>
                    </ol>
                </td>
            </tr>
        </table>

        <table>
            <tr>
                <td class="header">CONSIGNEE:</td>
                <td class="header">BUYER</td>
                <td class="header">NOTIFY PARTY (Other then Buyer)</td>
            </tr>
            <tr>
                <td style="width: 40%;">
                    <div class="bold" style="margin-top:2px;">
                        <%= order?.piInvoice?.partyName || order?.piInvoice?.party?.companyName || 'N/A' %>
                    </div>
                    <div>Address: <%= order?.piInvoice?.address || order?.piInvoice?.party?.address || '' %></div>
                    <div><%= order?.piInvoice?.country || order?.piInvoice?.party?.country || '' %></div>
                    <% if (order?.piInvoice?.phone || order?.piInvoice?.party?.phone) { %>
                        <div>Phone: <%= order?.piInvoice?.phone || order?.piInvoice?.party?.phone %></div>
                    <% } %>
                    <% if (order?.piInvoice?.email || order?.piInvoice?.party?.email) { %>
                        <div>Email: <%= order?.piInvoice?.email || order?.piInvoice?.party?.email %></div>
                    <% } %>
                </td>
                <td style="width: 40%;">
                    <div class="bold" style="margin-top:2px;">
                        <%= order?.buyer?.name || order?.piInvoice?.partyName || order?.piInvoice?.party?.companyName || 'N/A' %>
                    </div>
                    <div>Address: <%= order?.buyer?.address || order?.piInvoice?.party?.address || '' %></div>
                    <% if (order?.buyer?.phone || order?.piInvoice?.party?.phone) { %>
                        <div>Phone: <%= order?.buyer?.phone || order?.piInvoice?.party?.phone %></div>
                    <% } %>
                    <% if (order?.buyer?.email || order?.piInvoice?.party?.email) { %>
                        <div>Email: <%= order?.buyer?.email || order?.piInvoice?.party?.email %></div>
                    <% } %>
                </td>
                <td style="width: 20%;">
                    <div>
                        <%= order?.notifyParty?.name || order?.piInvoice?.notifyParty?.name || '' %>
                    </div>
                    <div>
                        <%= order?.notifyParty?.address || order?.piInvoice?.notifyParty?.address || '' %>
                    </div>
                    <% if (order?.notifyParty?.email || order?.piInvoice?.notifyParty?.email) { %>
                        <div>Email: <%= order?.notifyParty?.email || order?.piInvoice?.notifyParty?.email %></div>
                    <% } %>
                </td>
            </tr>
        </table>

        <table>
            <tr class="center header">
                <td>Pre Carriage By</td>
                <td>Place of Receipt by Pre-Carrier</td>
                <td>Country of Origin of Goods</td>
                <td>Country of Final Destination</td>
            </tr>
            <tr class="center">
                <td><%= order?.piInvoice?.preCarriageBy || 'ROAD' %></td>
                <td><%= order?.piInvoice?.placeOfReceipt || 'MORBI' %></td>
                <td><%= order?.piInvoice?.countryOfOrigin || 'INDIA' %></td>
                <td><%= order?.piInvoice?.countryOfDestination || order?.piInvoice?.country || 'USA' %></td>
            </tr>
            <tr class="center header">
                <td>Vessel/ Flight No</td>
                <td>Port of Loading</td>
                <td>Port of Discharge</td>
                <td>Final Destination</td>
            </tr>
            <tr class="center">
                <td><%= (typeof shipment !== 'undefined' && shipment?.vesselVoyageInfo) || order?.shipment?.vesselVoyageInfo || order?.piInvoice?.vesselFlightNo || '-' %></td>
                <td><%= order?.piInvoice?.portOfLoading || 'MUNDRA PORT, INDIA' %></td>
                <td><%= order?.piInvoice?.portOfDischarge || '-' %></td>
                <td><%= order?.piInvoice?.finalDestination || '-' %></td>
            </tr>
        </table>
        <% const products = order?.piInvoice?.products || []; %>
<%
/* ===============================
   WEIGHT BASED LANDED CALCULATION
   =============================== */

// 1. Product subtotal
const productSubtotal = products.reduce(
  (s, p) => s + Number(p.total || 0),
  0
);

// 2. Total extra charges
let totalExtraCharges = 0;
const ch = order?.piInvoice?.charges || {};

if (ch.insurance) totalExtraCharges += Number(ch.insurance);
if (ch.freightCharge) totalExtraCharges += Number(ch.freightCharge);
if (ch.transportationCharge) totalExtraCharges += Number(ch.transportationCharge);
if (ch.destinationPortHandlingCharge) totalExtraCharges += Number(ch.destinationPortHandlingCharge);

if (Array.isArray(ch.otherCharges)) {
  ch.otherCharges.forEach(c => {
    totalExtraCharges += Number(c.amount || 0);
  });
}

// Duty %
if (ch.dutyPercent) {
  totalExtraCharges += (productSubtotal * Number(ch.dutyPercent)) / 100;
}

// 3. Total weight
const totalWeight = products.reduce(
  (s, p) => s + Number(p.totalWeight || 0),
  0
);

// 4. Per KG charge
const perKgCharge = totalWeight > 0
  ? totalExtraCharges / totalWeight
  : 0;
%>


        <div class="table-title">Description of Goods</div>
        <table>
            <thead>
                <tr class="header center">
                    <th style="width: 4%;">S.No.</th>
                    <th style="width: 40%;">Description of Goods</th>
                    <th style="width: 8%;">HS Code</th>
                    <th style="width: 10%;">Quantity</th>
                    <th style="width: 6%;">Unit</th>
                    <th style="width: 10%;">Rate USD</th>
                    <th style="width: 10%;">Weight (Kgs)</th>
                    <th style="width: 12%;">Amount USD</th>
                </tr>
            </thead>
            <tbody>

<% products.forEach((product, index) => { %>
<%
  const qty = Number(product.quantity || 0);
  const baseTotal = Number(product.total || 0);
  const weight = Number(product.totalWeight || 0);

  const extraCharge = weight * perKgCharge;
  const finalTotal = baseTotal + extraCharge;
  const finalRate = qty > 0 ? finalTotal / qty : 0;
%>
                    <tr>
  <!-- 1 -->
  <td class="center"><%= index + 1 %></td>

  <!-- 2 -->
  <td>
    <strong><%= product.productName || 'N/A' %></strong>
    <% if (product.productDescription && product.productDescription !== product.productName) { %>
      <br><%= product.productDescription %>
    <% } %>
  </td>

  <!-- 3 -->
  <td class="center"><%= product.hsCode || 'N/A' %></td>

  <!-- 4 : Quantity -->
  <td class="right"><%= qty %></td>

  <!-- 5 : Unit -->
  <td class="center"><%= (product.unit || 'Square Meter') %> </td>

  <!-- 6 : Rate -->
  <td class="right"><%= finalRate.toFixed(4) %></td>

  <!-- 7 : Weight -->
  <td class="right"><%= weight.toFixed(0) %> kg</td>

  <!-- 8 : Amount -->
  <td class="right">$ <%= finalTotal.toFixed(2) %></td>
</tr>

                <% }) %>

             <tr class="bold header">
    <td colspan="7" class="center">TOTAL</td>
    <td class="right">$ <%= order.piInvoice.totalAmount.toFixed(2) %></td>
</tr>

                <tr class="bold">
                    <td colspan="8">
                        CONTAINER:- <%= order?.piInvoice?.numberOfContainers || 'N/A' %> X <%= (order?.piInvoice?.containerType || 'N/A').toUpperCase() %><br>
                        <% 
                            // Check if this is tiles (has totalPallets and totalVolume) or bagasse (only totalBoxes)
                            const hasPallets = order?.piInvoice?.totalPallets && order?.piInvoice?.totalPallets > 0;
                            const hasVolume = order?.piInvoice?.totalVolume && order?.piInvoice?.totalVolume > 0;
                        %>
                        <% if (hasPallets && hasVolume) { %>
                            TOTAL PALLETS:- <%= order.piInvoice.totalPallets %> | TOTAL BOXES:- <%= order?.piInvoice?.totalBoxes || 'N/A' %> | TOTAL SQM:- <%= order.piInvoice.totalSquareMeters.toFixed(2) %><br>
                        <% } else { %>
                            TOTAL BOXES:- <%= order?.piInvoice?.totalBoxes || 'N/A' %><br>
                        <% } %>
                        NET WEIGHT:- <%= (order?.piInvoice?.totalWeight || totalNet).toFixed(1) %> KG<br>
                        GROSS WEIGHT:- <%= (order?.piInvoice?.totalGrossWeight || totalGross).toFixed(1) %> KG
                    </td>
                </tr>
            </tbody>
        </table>

        
        <table>
            <tr>
                <td style="width: 70%;">
                    <div class="bold">AMOUNT IN WORDS (USD) :-</div>
                    <% 
                        const finalAmount = order?.piInvoice?.totalAmount || totalAmount;
                        function numberToWords(num) {
                            const ones = ['', 'ONE', 'TWO', 'THREE', 'FOUR', 'FIVE', 'SIX', 'SEVEN', 'EIGHT', 'NINE', 'TEN', 'ELEVEN', 'TWELVE', 'THIRTEEN', 'FOURTEEN', 'FIFTEEN', 'SIXTEEN', 'SEVENTEEN', 'EIGHTEEN', 'NINETEEN'];
                            const tens = ['', '', 'TWENTY', 'THIRTY', 'FORTY', 'FIFTY', 'SIXTY', 'SEVENTY', 'EIGHTY', 'NINETY'];
                            
                            if (num === 0) return 'ZERO';
                            if (num < 20) return ones[num];
                            if (num < 100) return tens[Math.floor(num/10)] + (num%10 ? ' ' + ones[num%10] : '');
                            if (num < 1000) return ones[Math.floor(num/100)] + ' HUNDRED' + (num%100 ? ' ' + numberToWords(num%100) : '');
                            if (num < 1000000) return numberToWords(Math.floor(num/1000)) + ' THOUSAND' + (num%1000 ? ' ' + numberToWords(num%1000) : '');
                            return numberToWords(Math.floor(num/1000000)) + ' MILLION' + (num%1000000 ? ' ' + numberToWords(num%1000000) : '');
                        }
                        const amountInWords = finalAmount ? numberToWords(Math.floor(finalAmount)) + ' DOLLARS ONLY' : '';
                    %>
                    <%= amountInWords %>
                </td>
                <td style="width: 30%;">
                    <table style="width:100%; border-collapse:collapse;">
                        <% if (order?.charges && Object.keys(order.charges).length > 0) { %>
                            <% Object.entries(order.charges).forEach(([key, value]) => { %>
                                <% if (key === 'otherCharges' && Array.isArray(value)) { %>
                                    <% value.forEach((charge) => { %>
                                        <tr>
                                            <td style="border: var(--inner); padding:8px 6px; font-weight:bold;">
                                                <%= charge.name.toUpperCase() %>:-
                                            </td>
                                            <td class="right" style="border: var(--inner); padding:8px 6px; font-weight:bold;">
                                                <%= charge.amount && !isNaN(parseFloat(charge.amount)) ? '$' + parseFloat(charge.amount).toFixed(2) : '-' %>
                                            </td>
                                        </tr>
                                    <% }) %>
                                <% } else { %>
                                    <tr>
                                        <td style="border: var(--inner); padding:8px 6px; font-weight:bold;">
                                            <%= key.toUpperCase() %>:-
                                        </td>
                                        <td class="right" style="border: var(--inner); padding:8px 6px; font-weight:bold;">
                                            <%= value && !isNaN(parseFloat(value)) ? '$' + parseFloat(value).toFixed(2) : '-' %>
                                        </td>
                                    </tr>
                                <% } %>
                            <% }) %>
                        <% } %>
                        <tr>
                            <td style="border: var(--inner); padding:8px 6px; font-weight:bold;">TOTAL AMOUNT:-</td>
                            <td class="right" style="border: var(--inner); padding:8px 6px; font-weight:bold;">
                                $ <%= (order?.piInvoice?.totalAmount || totalAmount).toFixed(2) %>
                            </td>
                        </tr>
                        <% 
                            // Calculate duty amount
                            const dutyPercent = Number(order?.piInvoice?.charges?.dutyPercent || 0);
                            const dutyAmount = (order?.piInvoice?.subtotal || 0) * dutyPercent / 100;
                            
                            // Calculate freight and other charges
                            const charges = order?.piInvoice?.charges || {};
                            let freightAndOtherCharges = 0;
                            if (charges.insurance) freightAndOtherCharges += Number(charges.insurance);
                            if (charges.freightCharge) freightAndOtherCharges += Number(charges.freightCharge);
                            if (charges.transportationCharge) freightAndOtherCharges += Number(charges.transportationCharge);
                            if (charges.destinationPortHandlingCharge) freightAndOtherCharges += Number(charges.destinationPortHandlingCharge);
                            if (Array.isArray(charges.otherCharges)) {
                                charges.otherCharges.forEach(c => {
                                    freightAndOtherCharges += Number(c.amount || 0);
                                });
                            }
                            
                            // Calculate final amount
                            const totalChargesSum = dutyAmount + freightAndOtherCharges;
                            const finalTotalAmount = (order?.piInvoice?.totalAmount || 0) - totalChargesSum;
                        %>
                        <% if (totalChargesSum > 0) { %>
                        <tr>
                            <td style="border: var(--inner); padding:8px 6px; font-weight:bold;">Duty and Other:-</td>
                            <td class="right" style="border: var(--inner); padding:8px 6px; font-weight:bold;">
                                $ <%= totalChargesSum.toFixed(2) %>
                            </td>
                        </tr>
                        <% } %>
                        <% if (totalChargesSum > 0) { %>
                        <tr style="background: var(--grey);">
                            <td style="border: var(--inner); padding:8px 6px; font-weight:bold;">FINAL AMOUNT:-</td>
                            <td class="right" style="border: var(--inner); padding:8px 6px; font-weight:bold;">
                                $ <%= finalTotalAmount.toFixed(2) %>
                            </td>
                        </tr>
                        <% } %>
                    </table>
                </td>
            </tr>
        </table>

        <table>
            <tr>
                <td class="header" colspan="2">BANK DETAILS :-</td>
            </tr>
            <tr>
                <td style="width: 80%; padding: 10px; vertical-align: top;">
                    <% 
                        // Try to get bank details from selectedBank or fall back to company bank details
                        const selectedBank = order?.piInvoice?.selectedBank || {};
                        const companyBank = order?.company || {};
                        
                        // Use selectedBank if available, otherwise fall back to company bank details
                        const bankName = selectedBank?.bankName || companyBank?.bankName || 'N/A';
                        const bankAddress = selectedBank?.bankAddress || companyBank?.bankAddress || '';
                        const accountNumber = selectedBank?.accountNumber || companyBank?.accountNumber || 'N/A';
                        const ifscCode = selectedBank?.ifscCode || companyBank?.ifscCode || 'N/A';
                        const swiftCode = selectedBank?.swiftCode || companyBank?.swiftCode || 'N/A';
                    %>
                    <div style="font-size: 10px; margin-bottom: 2px;"><strong>BANK NAME :-</strong> <%= bankName %></div>
                    <div style="font-size: 10px; margin-bottom: 2px;"><strong>BANK ADDRESS :-</strong> <%= bankAddress %></div>
                    <div style="font-size: 10px; margin-bottom: 2px;"><strong>ACCOUNT NUMBER :-</strong> <%= accountNumber %></div>
                    <div style="font-size: 10px; margin-bottom: 2px;"><strong>IFSC CODE :-</strong> <%= ifscCode %></div>
                    <div style="font-size: 10px;"><strong>SWIFT CODE :-</strong> <%= swiftCode %></div>
                </td>
                <td style="width: 20%; text-align: center; vertical-align: top; padding: 10px;">
                    <div style="margin-bottom: 10px;">
                        <strong>For, <%= order?.company?.name || 'COMPANY NAME' %></strong>
                    </div>
                    <div style="height: 60px; display: flex; align-items: center; justify-content: center;">
                        <% const signatureUrl = order?.company?.signature; %>
                        <% const fullSignatureUrl = signatureUrl ? (signatureUrl.startsWith('http') ? signatureUrl : `http://localhost:8000${signatureUrl}`) : null; %>
                        <% if (typeof signatureBase64 !== 'undefined' && signatureBase64) { %>
                            <img src="data:image/*;base64,<%= signatureBase64 %>" alt="Signature" style="max-height: 50px; max-width: 80px; object-fit: contain;">
                        <% } else if (fullSignatureUrl) { %>
                            <img src="<%= fullSignatureUrl %>" alt="Signature" style="max-height: 50px; max-width: 80px; object-fit: contain;">
                        <% } else { %>
                            <div style="width: 80px; height: 50px; border: 1px dashed #ccc; display: flex; align-items: center; justify-content: center; font-size: 8px; color: #999;">
                                SIGNATURE
                            </div>
                        <% } %>
                    </div>
                    <div style="margin-top: 8px;">
                        <div style="border-bottom: 1px solid #000; width: 80px; margin: 0 auto;"></div>
                        <div style="font-size: 8px; margin-top: 2px;">Authorised Signatory</div>
                    </div>
                </td>
            </tr>
        </table>

        <% if (order?.notes && order.notes.trim()) { %>
        <table>
            <tr>
                <td class="header" style="background: var(--grey); font-weight: bold; padding: 6px;">NOTES:</td>
            </tr>
            <tr>
                <td style="padding: 6px; vertical-align: top; font-size: 10px; line-height: 1.3; border: var(--inner); white-space: pre-line;">
                    <%= order.notes %>
                </td>
            </tr>
        </table>
        <% } %>

        <table>
            <tr>
                <td style="padding: 10px; vertical-align: top;">
                    <div>
                        We Declare that this Invoice shows the Actual prices of the goods described and that particulars are true and correct.
                    </div>
                </td>
            </tr>
        </table>
    </div>
</body>

</html>

