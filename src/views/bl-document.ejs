<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Bill of Lading</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            font-size: 11px;
            line-height: 1.2;
            color: #000;
            background: white;
        }
        
        .bl-container {
            width: 240mm;
            min-height: 297mm;
            margin: 0 auto;
            padding: 12mm;
            background: white;
        }
        
        @media print {
            .bl-container {
                margin: 0;
                padding: 5mm;
            }
        }
    </style>
</head>
<body>
    <div class="bl-container">
        <!-- Header with Logo and Title -->
        <div style="display: flex; align-items: center; margin-bottom: 20px; border-bottom: 3px solid #000; padding-bottom: 15px;">
            <div style="width: 100px; margin-right: 20px;">
                <% if (logoBase64) { %>
                    <img src="data:image/png;base64,<%= logoBase64 %>" alt="Company Logo" style="max-width: 100%; max-height: 80px; object-fit: contain;">
                <% } %>
            </div>
            <div style="flex: 1; text-align: center;">
                <h1 style="font-size: 28px; font-weight: bold; margin: 0;">BILL OF LADING DRAFT</h1>
                <div style="font-size: 14px; margin-top: 5px;">COMBINED TRANSPORT DOCUMENT OR PORT TO PORT SHIPMENT</div>
            </div>
        </div>

        <!-- Top Section Grid -->
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 0;">
            <tr>
                <td style="width: 50%; border: 2px solid #000; padding: 12px; vertical-align: top;">
                    <div style="font-weight: bold; font-size: 13px; margin-bottom: 8px;">SHIPPER( MAX 5 LINES)</div>
                    <div style="font-size: 12px; line-height: 1.3;">
                        <%= company.name %><br>
                        <%= company.address %>
                    </div>
                </td>
                <td style="width: 50%; border: 2px solid #000; border-left: none; padding: 12px; vertical-align: top; text-align: right;">
                    <div style="font-weight: bold; font-size: 16px; font-style: italic;">BOOKING NO:</div>
                    <div style="font-size: 18px; font-weight: bold; margin-top: 5px;"><%=  shipment.blNumber %></div>
                </td>
            </tr>
        </table>

        <table style="width: 100%; border-collapse: collapse; margin-bottom: 0;">
            <tr>
                <td style="width: 100%; border: 2px solid #000; border-top: none; padding: 10px; vertical-align: top;">
                    <div style="font-weight: bold; font-size: 11px; margin-bottom: 8px;">Consignee:</div>
                    <div style="font-size: 10px; line-height: 1.3;">
                        <%= piInvoice.partyName || (piInvoice.party && piInvoice.party.companyName) || '' %><br>
                        <%= piInvoice.address || (piInvoice.party && piInvoice.party.address) || '' %><br>
                        <% if (piInvoice.phone || (piInvoice.party && piInvoice.party.phone)) { %>PHONE: <%= piInvoice.phone || piInvoice.party.phone %><br><% } %>
                        <% if (piInvoice.email || (piInvoice.party && piInvoice.party.email)) { %>EMAIL: <%= piInvoice.email || piInvoice.party.email %><% } %>
                    </div>
                </td>
            </tr>
        </table>

        <table style="width: 100%; border-collapse: collapse; margin-bottom: 0;">
            <tr>
                <td style="width: 50%; border: 2px solid #000; border-top: none; padding: 10px; vertical-align: top;">
                    <div style="font-weight: bold; font-size: 11px; margin-bottom: 8px;">Notify Party:</div>
                    <div style="font-size: 10px; line-height: 1.3;">
                        <%= piInvoice.partyName || (piInvoice.party && piInvoice.party.companyName) || '' %><br>
                        <%= piInvoice.address || (piInvoice.party && piInvoice.party.address) || '' %><br>
                        <% if (piInvoice.phone || (piInvoice.party && piInvoice.party.phone)) { %>PHONE: <%= piInvoice.phone || piInvoice.party.phone %><br><% } %>
                        <% if (piInvoice.email || (piInvoice.party && piInvoice.party.email)) { %>EMAIL: <%= piInvoice.email || piInvoice.party.email %><% } %>
                    </div>
                </td>
                <td style="width: 50%; border: 2px solid #000; border-top: none; border-left: none; padding: 10px; vertical-align: top;">
                    <div style="font-weight: bold; font-size: 11px; margin-bottom: 8px;">2.Notify Party: ( MAX 5 LINES)</div>
                </td>
            </tr>
        </table>

        <table style="width: 100%; border-collapse: collapse; margin-bottom: 0;">
            <tr>
                <td style="width: 50%; border: 2px solid #000; border-top: none; padding: 10px; vertical-align: top;">
                    <div style="font-weight: bold; font-size: 11px; margin-bottom: 8px;">Vessel and Voyage No:</div>
                    <div style="font-size: 10px; font-weight: bold;">
                        <% if (piInvoice.packingLists && piInvoice.packingLists.length > 0 && piInvoice.packingLists[0].notes && piInvoice.packingLists[0].notes.vesselVoyageNo) { %>
                            <%= piInvoice.packingLists[0].notes.vesselVoyageNo %>
                        <% } else { %>
                            <%= bl.vesselName %> VOY <%= bl.voyageNumber %>
                        <% } %>
                    </div>
                </td>
                <td style="width: 50%; border: 2px solid #000; border-top: none; border-left: none; padding: 10px; vertical-align: top;">
                    <div style="font-weight: bold; font-size: 11px; margin-bottom: 8px;">Place of Receipt:</div>
                    <div style="font-size: 10px;">
                        <%= piInvoice.placeOfReceipt %>
                    </div>
                </td>
            </tr>
        </table>

        <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
            <tr>
                <td style="width: 33.33%; border: 2px solid #000; border-top: none; padding: 10px; vertical-align: top;">
                    <div style="font-weight: bold; font-size: 11px; margin-bottom: 8px;">Port of Loading:</div>
                    <div style="font-size: 10px; font-weight: bold;">
                        <%= piInvoice.portOfLoading %>
                    </div>
                </td>
                <td style="width: 33.33%; border: 2px solid #000; border-top: none; border-left: none; padding: 10px; vertical-align: top;">
                    <div style="font-weight: bold; font-size: 11px; margin-bottom: 8px;">Port of Discharge:</div>
                    <div style="font-size: 10px; font-weight: bold;">
                        <%= piInvoice.portOfDischarge %>
                    </div>
                </td>
                <td style="width: 33.33%; border: 2px solid #000; border-top: none; border-left: none; padding: 10px; vertical-align: top;">
                    <div style="font-weight: bold; font-size: 11px; margin-bottom: 8px;">Place of Delivery:</div>
                    <div style="font-size: 10px; font-weight: bold;">
                        <%= piInvoice.finalDestination %>
                    </div>
                </td>
            </tr>
        </table>

        <!-- Main Cargo Details Table -->
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 0;">
            <thead>
                <tr>
                    <th style="width: 20%; border: 2px solid #000; padding: 10px; background-color: #f0f0f0; font-size: 12px; font-weight: bold; text-align: center;">Container Nos. Marks & Numbers</th>
                    <th style="width: 60%; border: 2px solid #000; border-left: none; padding: 10px; background-color: #f0f0f0; font-size: 12px; font-weight: bold; text-align: center;">Number and Kind of Packages & Description of Goods</th>
                    <th style="width: 20%; border: 2px solid #000; border-left: none; padding: 10px; background-color: #f0f0f0; font-size: 12px; font-weight: bold; text-align: center;">Gross Weight</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="border: 2px solid #000; border-top: none; padding: 12px; vertical-align: top; font-size: 11px;">
                        <strong>TOTAL</strong><br>
                        <% 
                        // Calculate dynamic packaging data
                        let totalBoxes = 0;
                        let totalPallets = 0;
                        
                        if (piInvoice.packingLists && piInvoice.packingLists.length > 0 && piInvoice.packingLists[0].notes && piInvoice.packingLists[0].notes.containers) {
                            piInvoice.packingLists[0].notes.containers.forEach(container => {
                                totalBoxes += parseInt(container.totalNoOfBoxes) || 0;
                                totalPallets += parseInt(container.totalPallets) || 0;
                            });
                        } else if (order && order.packingLists) {
                            totalPallets = order.packingLists.reduce((sum, step) => sum + (parseFloat(step.quantity) || 0), 0);
                        } else {
                            totalPallets = piInvoice.totalPallets || 0;
                        }
                        %>
                        
                        <% if (totalBoxes > 0) { %>
                            <%= totalBoxes %> BOXES<br>
                        <% } %>
                        <% if (totalPallets > 0) { %>
                            <%= totalPallets %> PALLETS<br>
                        <% } %>
                        
                        <% if (bl.marksAndNumbers && bl.marksAndNumbers.trim() !== 'TBD') { %>
                            <%= bl.marksAndNumbers %>
                        <% } %>
                    </td>
                    
                    <td style="border: 2px solid #000; border-top: none; border-left: none; padding: 12px; vertical-align: top; font-size: 11px; line-height: 1.3;">
                        <% 
                        const containerCount = (piInvoice.packingLists && piInvoice.packingLists[0] && piInvoice.packingLists[0].notes && piInvoice.packingLists[0].notes.containers) ? piInvoice.packingLists[0].notes.containers.length : (order && order.packingLists ? order.packingLists.length : 1);
                        const containerSize = piInvoice.containerType || "20' FCL";
                        %>
                        
                        <strong><%= containerCount.toString().padStart(2, '0') %>X <%= containerSize %> CONTAINER</strong><br>
                        <strong>SAID TO CONTAIN</strong><br><br>
                        
                        <% if (piInvoice.products && piInvoice.products.length > 0) { %>
                            <% 
                            // Group products by HSN code and get individual box counts
                            const productsByHsn = {};
                            
                            // First, collect all products with their box counts from containers
                            const productBoxCounts = {};
                            if (piInvoice.packingLists && piInvoice.packingLists.length > 0 && piInvoice.packingLists[0].notes && piInvoice.packingLists[0].notes.containers) {
                                piInvoice.packingLists[0].notes.containers.forEach(container => {
                                    if (container.products) {
                                        container.products.forEach(containerProduct => {
                                            if (containerProduct.productData) {
                                                const productId = containerProduct.productData._id || containerProduct.productData.productName;
                                                if (!productBoxCounts[productId]) {
                                                    productBoxCounts[productId] = 0;
                                                }
                                                productBoxCounts[productId] += parseInt(containerProduct.noOfBoxes) || 0;
                                            }
                                        });
                                    }
                                });
                            }
                            
                            // Group products by HSN
                            piInvoice.products.forEach(product => {
                                const hsn = product.hsCode || 'NO_HSN';
                                if (!productsByHsn[hsn]) {
                                    productsByHsn[hsn] = [];
                                }
                                
                                const productId = product._id || product.productName;
                                const boxCount = productBoxCounts[productId] || 0;
                                
                                productsByHsn[hsn].push({
                                    ...product,
                                    boxCount: boxCount
                                });
                            });
                            %>
                            
                            <% Object.keys(productsByHsn).forEach(hsn => { %>
                                <% if (hsn !== 'NO_HSN') { %>HS CODE: <%= hsn %><br><% } %>
                                <% productsByHsn[hsn].forEach(product => { %>
                                    <%= product.productName %>
                                    <% if (product.boxCount > 0) { %> - <%= product.boxCount %> BOXES<% } %>
                                    <br>
                                <% }) %>
                                <br>
                            <% }) %>
                        <% } %>
                        
                        <% if (bl.descriptionOfGoods && bl.descriptionOfGoods.trim() !== 'TBD') { %>
                            <%= bl.descriptionOfGoods %><br>
                        <% } %>
                        
                        <% if (piInvoice.piNumber) { %>
                            <br><strong>INVOICE NO:</strong> <%= piInvoice.piNumber %>
                            <% if (piInvoice.invoiceDate) { %> DT. <%= new Date(piInvoice.invoiceDate).toLocaleDateString('en-GB') %><% } %><br>
                        <% } %>
                        
                        <% if (order && order.wayBillNumber) { %>
                            <strong>S/BILL NO:</strong> <%= order.wayBillNumber %> DT.: <%= new Date().toLocaleDateString('en-GB') %><br>
                        <% } %>
                        
                        <% 
                        // Calculate total weights from containers
                        let totalGrossWeight = 0;
                        let totalNetWeight = 0;
                        
                        if (piInvoice.packingLists && piInvoice.packingLists.length > 0 && piInvoice.packingLists[0].notes && piInvoice.packingLists[0].notes.containers) {
                            piInvoice.packingLists[0].notes.containers.forEach(container => {
                                totalGrossWeight += parseFloat(container.totalGrossWeight) || 0;
                                totalNetWeight += parseFloat(container.totalNetWeight) || 0;
                            });
                        }
                        
                        // Fallback to bl data if container data not available
                        if (totalGrossWeight === 0 && bl.grossWeight) {
                            totalGrossWeight = parseFloat(bl.grossWeight) || 0;
                        }
                        if (totalNetWeight === 0 && bl.netWeight) {
                            totalNetWeight = parseFloat(bl.netWeight) || 0;
                        }
                        %>
                        
                        <br><strong>TOTAL GROSS WEIGHT:</strong> <%= totalGrossWeight.toFixed(2) %> KGS<br>
                        <strong>TOTAL NET WEIGHT:</strong> <%= totalNetWeight.toFixed(2) %> KGS<br>
                        
                        <% if (piInvoice.finalDestination) { %>
                            <br><strong>DOOR DELIVERY ADDRESS:</strong><br><%= piInvoice.finalDestination %><br>
                        <% } %>
                        
                        <br>ALL OTHER DETAILS AS PER INVOICE AND PACKING LIST
                    </td>
                    
                    <td style="border: 2px solid #000; border-top: none; border-left: none; padding: 12px; vertical-align: top; text-align: center; font-size: 13px;">
                        <strong><%= totalGrossWeight.toFixed(2) %></strong><br>
                        <strong>KGS</strong>
                    </td>
                </tr>
            </tbody>
        </table>

        <!-- Container Details Table -->
        <table style="width: 100%; border-collapse: collapse; margin-top: 15px; margin-bottom: 20px;">
            <thead>
                <tr style="background-color: #90EE90;">
                    <th style="border: 2px solid #000; padding: 6px; font-size: 9px; font-weight: bold; text-align: center;">Container No.</th>
                    <th style="border: 2px solid #000; border-left: none; padding: 6px; font-size: 9px; font-weight: bold; text-align: center;">Seal No.</th>
                    <th style="border: 2px solid #000; border-left: none; padding: 6px; font-size: 9px; font-weight: bold; text-align: center;">Unit</th>
                    <th style="border: 2px solid #000; border-left: none; padding: 6px; font-size: 9px; font-weight: bold; text-align: center;">Quantity</th>
                    <th style="border: 2px solid #000; border-left: none; padding: 6px; font-size: 9px; font-weight: bold; text-align: center;">Gross wt (Kgs)</th>
                    <th style="border: 2px solid #000; border-left: none; padding: 6px; font-size: 9px; font-weight: bold; text-align: center;">Nett wt (Kgs)</th>
                </tr>
            </thead>
            <tbody>
                <% if (piInvoice.packingLists && piInvoice.packingLists.length > 0 && piInvoice.packingLists[0].notes && piInvoice.packingLists[0].notes.containers) { %>
                    <% piInvoice.packingLists[0].notes.containers.forEach(container => { %>
                        <tr>
                            <td style="border: 2px solid #000; border-top: none; padding: 6px; font-size: 9px; text-align: center;"><%= container.containerNumber %></td>
                            <td style="border: 2px solid #000; border-top: none; border-left: none; padding: 6px; font-size: 9px; text-align: center;"><%= container.sealNumber %></td>
                            <td style="border: 2px solid #000; border-top: none; border-left: none; padding: 6px; font-size: 9px; text-align: center;"><%= container.products && container.products.length > 0 && container.products[0].productData && container.products[0].productData.category ? (container.products[0].productData.category.secondary_unit || 'BOXES').toUpperCase() : 'BOXES' %></td>
                            <td style="border: 2px solid #000; border-top: none; border-left: none; padding: 6px; font-size: 9px; text-align: center;"><%= container.totalNoOfBoxes %></td>
                            <td style="border: 2px solid #000; border-top: none; border-left: none; padding: 6px; font-size: 9px; text-align: center;"><%= parseFloat(container.totalGrossWeight).toFixed(2) %></td>
                            <td style="border: 2px solid #000; border-top: none; border-left: none; padding: 6px; font-size: 9px; text-align: center;"><%= parseFloat(container.totalNetWeight).toFixed(2) %></td>
                        </tr>
                    <% }) %>
                <% } else { %>
                    <tr>
                        <td colspan="6" style="border: 2px solid #000; border-top: none; padding: 10px; font-size: 9px; text-align: center; font-style: italic;">No container details available</td>
                    </tr>
                <% } %>
            </tbody>
        </table>

    </div>
</body>
</html>