<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Commercial Packing List</title>
    <style>
        :root {
            --outer: 2px solid #000;
            --inner: 1px solid #000;
            --grey: #e0e0e0;
        }

        body {
            font-family: Arial, sans-serif;
            font-size: 10px;
            margin: 10px;
        }

        .page {
            border: var(--outer);
        }

        .title {
            background: var(--grey);
            text-align: center;
            font-weight: 700;
            font-size: 16px;
            padding: 6px 8px;
            border-bottom: var(--inner);
        }

        .subtitle {
            text-align: center;
            padding: 6px 8px;
            border-bottom: var(--inner);
            font-size: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            border: var(--inner);
            padding: 6px;
            vertical-align: top;
        }

        .header {
            background: var(--grey);
            font-weight: bold;
        }

        .center {
            text-align: center;
        }

        .right {
            text-align: right;
        }

        .bold {
            font-weight: bold;
        }

        .section-title {
            font-weight: bold;
            margin-top: 12px;
            margin-bottom: 4px;
        }

        .note {
            font-style: italic;
            font-size: 10px;
        }

        .footer {
            margin-top: 30px;
            font-size: 10px;
        }

        .table-title {
            text-align: center;
            border-left: var(--inner);
            border-right: var(--inner);
            border-bottom: var(--inner);
            background: var(--grey);
            padding: 6px 4px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <!-- DEBUG: Product data structure -->
    <!-- <pre><%= JSON.stringify(piInvoice.products?.[0] || (piInvoice.packingLists?.[0]?.notes?.containers?.[0]?.products?.[0]), null, 2) %></pre> -->
    <!-- <pre><%= JSON.stringify(packingListData) %></pre> -->
    <div class="page">
        <div class="title">COMMERCIAL PACKING LIST</div>
        <div class="subtitle">SUPPLY MEANT FOR EXPORT UNDER BOND &amp; LUT - LETTER OF UNDERTAKING WITHOUT PAYMENT OF
            INTEGRATED TAX</div>

        <!-- Top block exactly like PL1.png: Exporter left, Invoice/Date + Buyer Ref + Terms right -->
        <% const invDateObj=packingListData.exportInvoiceDate ? new Date(packingListData.exportInvoiceDate) :
            (piInvoice.invoiceDate ? new Date(piInvoice.invoiceDate) : null); %>
            <% const invDateStr=invDateObj ? invDateObj.toLocaleDateString('en-GB', { day:'2-digit', month:'long',
                year:'numeric' }).replace(/ /g, '-' ) : 'N/A' ; %>

                <table>
                    <tr>
                        <!-- Left large cell: EXPORTER -->
                        <td rowspan="3" style="width: 60%;">
                            <div style="display: flex; align-items: flex-start; gap: 10px;">
                                <div style="flex: 1;">
                                    <div class="bold" style="text-decoration: underline;">EXPORTER:</div>
                                    <div class="bold" style="margin-top: 4px; font-size: 12px;">
                                        <%= piInvoice.company?.name || 'N/A' %>
                                    </div>
                                    <div>
                                        <%= piInvoice.company?.address || '' %>
                                    </div>
                                    <div>
                                        <%= piInvoice.company.city || '' %>
                                            <%= piInvoice.company.state ? ', ' + piInvoice.company.state : '' %>
                                                <%= piInvoice.company.pincode ? ', ' + piInvoice.company.pincode : '' %>
                                    </div>
                                    <div>Phone: <%= piInvoice.company.phoneNo || '+91-XXXXXXXXXX' %>
                                    </div>
                                    <div>Email: <%= piInvoice.company.email || 'email@company.com' %>
                                    </div>

                                </div>
                                <div class="logo-box" style="text-align:right;">
                                    <% const logoUrl=piInvoice.company?.logo; %>
                                        <% const fullLogoUrl=logoUrl ? (logoUrl.startsWith('http') ? logoUrl :
                                            `http://localhost:8000${logoUrl}`) : null; %>
                                            <% if (typeof logoBase64 !=='undefined' && logoBase64) { %>
                                                <img class="logo-img" src="data:image/*;base64,<%= logoBase64 %>" alt="Company Logo" style="max-height: 80px; max-width: 200px; object-fit: contain; border-radius: 8px; border: none; padding: 4px;">
                                                <% } else if (fullLogoUrl) { %>
                                                    <img class="logo-img" src="<%= fullLogoUrl %>" alt="Company Logo" style="max-height: 80px; max-width: 200px; object-fit: contain; border-radius: 8px; border: none; padding: 4px;">
                                                    <% } %>
                                </div>
                            </div>
                        </td>
                        <!-- Right top row: Invoice No and Date -->
                        <td style="width: 20%;" class="center">
                            <div class="bold">Invoice No:</div>
                            <div class="bold" style="font-size: 12px; margin-top: 2px;">
                                <%= packingListData.exportInvoiceNo || piInvoice.piNumber || 'N/A' %>
                            </div>
                        </td>
                        <td style="width: 20%;" class="center">
                            <div class="bold">Date:</div>
                            <div class="bold" style="font-size: 12px; margin-top: 2px;">
                                <%= invDateStr %>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2" class="bold">Buyer's Ref No. &amp; Date :-</td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <div class="bold">Terms &amp; Conditions :-</div>
                            <ol style="margin: 4px 0 0 16px; padding: 0;">
                                <li>TRADE TERM: <%= packingListData.methodOfDispatch || piInvoice.deliveryTerm || 'N/A'
                                        %>
                                </li>
                                <li>PAYMENT TERM: <%= piInvoice.paymentTerm || 'N/A' %>
                                </li>
                            </ol>
                        </td>
                    </tr>
                </table>

                <!-- CONSIGNEE / BUYER / NOTIFY PARTY headers -->
                <table>
                    <tr>
                        <td class="header">CONSIGNEE:</td>
                        <td class="header">BUYER</td>
                        <td class="header">NOTIFY PARTY (Other then Buyer)</td>
                    </tr>
                    <tr>
                        <td style="width: 40%;">
                            <% 
                                // Check if showToTheOrder is enabled from packing list data or packing list entry
                                const showToTheOrder = (piInvoice.packingLists && piInvoice.packingLists[0] && piInvoice.packingLists[0].showToTheOrder) || 
                                                      (packingListData && packingListData.showToTheOrder) || false;
                            %>
                            <% if (showToTheOrder) { %>
                                <div class="bold" style="margin-top:2px; font-size: 14px; text-align: center; padding: 20px;">
                                    TO THE ORDER
                                </div>
                            <% } else { %>
                                <div class="bold" style="margin-top:2px;">
                                    <%= packingListData.consigneeDetails || piInvoice.party?.companyName ||
                                        piInvoice.partyName || 'N/A' %>
                                </div>
                                <div>Address: <%= piInvoice.party?.address || piInvoice.address || '' %>
                                </div>
                                <% if (piInvoice.party?.buildingName) { %>
                                    <div>Building Name: <%= piInvoice.party.buildingName %>
                                    </div>
                                    <% } %>
                                        <div>
                                            <%= piInvoice.party?.city || '' %>
                                                <%= piInvoice.party?.state ? ', ' + piInvoice.party.state : '' %>
                                                    <%= piInvoice.party?.zip || '' %>
                                        </div>
                                        <% if (piInvoice.party?.phone) { %>
                                            <div>Phone: <%= piInvoice.party.phone %>
                                            </div>
                                            <% } %>
                                                <% if (piInvoice.party?.email) { %>
                                                    <div>Email: <%= piInvoice.party.email %>
                                                    </div>
                                                    <% } %>
                            <% } %>
                        </td>
                        <td style="width: 40%;">
                            <div class="bold" style="margin-top:2px;">
                                <%= piInvoice.party?.companyName || piInvoice.partyName || 'N/A' %>
                            </div>
                            <div>Address: <%= piInvoice.party?.address || piInvoice.address || '' %>
                            </div>
                            <% if (piInvoice.party?.buildingName) { %>
                                <div>Building Name: <%= piInvoice.party.buildingName %>
                                </div>
                                <% } %>
                                    <div>
                                        <%= piInvoice.party?.city || '' %>
                                            <%= piInvoice.party?.state ? ', ' + piInvoice.party.state : '' %>
                                                <%= piInvoice.party?.zip || '' %>
                                    </div>
                                    <% if (piInvoice.party?.phone) { %>
                                        <div>Phone: <%= piInvoice.party.phone %>
                                        </div>
                                        <% } %>
                                            <% if (piInvoice.party?.email) { %>
                                                <div>Email: <%= piInvoice.party.email %>
                                                </div>
                                                <% } %>
                        </td>
                        <td style="width: 20%;"></td>
                    </tr>
                </table>

                <!-- Shipment info -->
                <table>
                    <tr class="center header">
                        <td>Pre Carriage By</td>
                        <td>Place of Receipt by Pre-Carrier</td>
                        <td>Country of Origin of Goods</td>
                        <td>Country of Final Destination</td>
                    </tr>
                    <tr class="center">
                        <td>
                            <%= piInvoice.preCarriageBy || 'ROAD' %>
                        </td>
                        <td>
                            <%= piInvoice.placeOfReceipt || packingListData.portOfLoading || 'MORBI' %>
                        </td>
                        <td>
                            <%= piInvoice.countryOfOrigin || packingListData.countryOfOrigin || piInvoice.country
                                || 'INDIA' %>
                        </td>
                        <td>
                            <%= piInvoice.countryOfDestination || packingListData.finalDestinationCountry ||
                                piInvoice.party?.country || 'USA' %>
                        </td>
                    </tr>
                    <tr class="center header">
                        <td>Vessel/ Flight No</td>
                        <td>Port of Loading</td>
                        <td>Port of Discharge</td>
                        <td>Final Destination</td>
                    </tr>
                    <tr class="center">
                        <td>
                            <%= (typeof shipment !== 'undefined' && shipment?.vesselVoyageInfo) || '-' %>
                        </td>
                        <td>
                            <%= piInvoice.portOfLoading || '-' %>
                        </td>
                        <td>
                            <%= piInvoice.portOfDischarge || '-' %>
                        </td>
                        <td>
                            <%= piInvoice.finalDestination || '-' %>
                        </td>
                    </tr>
                </table>

                <!-- Packing List Preview Table -->
                <div class="table-title">Description of Goods</div>
                <% const allContainers = piInvoice.packingLists && piInvoice.packingLists[0] &&
                    piInvoice.packingLists[0].notes && piInvoice.packingLists[0].notes.containers ?
                    piInvoice.packingLists[0].notes.containers : []; %>
                <% 
                    // Based on unit type (if tiles always use sqm/sqft)
                    let hasTilesProducts = false;
                    if (allContainers.length > 0) {
                        allContainers.forEach(containerData => {
                            const items = containerData && containerData.products ? containerData.products : [];
                            items.forEach(p => {
                                const tilesUnits = ['sqm', 'sqft', 'square meter'];
                                const isTilesProduct = tilesUnits.includes(p.unit?.toLowerCase()) && 
                                                      ((p.noOfBoxes && p.noOfBoxes > 0) || (p.noOfPallets && p.noOfPallets > 0));
                                if (isTilesProduct) {
                                    hasTilesProducts = true;
                                }
                            });
                        });
                    } else {
                        const items = piInvoice.products || [];
                        items.forEach(p => {
                            const tilesUnits = ['sqm', 'sqft', 'square meter'];
                            const isTilesProduct = tilesUnits.includes(p.unit?.toLowerCase()) && 
                                                  ((p.calculatedBoxes && p.calculatedBoxes > 0) || (p.calculatedPallets && p.calculatedPallets > 0));
                            if (isTilesProduct) {
                                hasTilesProducts = true;
                            }
                        });
                    }
                %>
                <table>
                    <thead>
                        <% if (hasTilesProducts) { %>
                            <tr class="header center">
                                <th style="width:5%;">Sr.</th>
                                <th style="width:18%;">Product Name</th>
                                <th style="width:10%;">Container</th>
                                <th style="width:8%;">HSN Code</th>
                                <th style="width:7%;">Unit</th>
                                <th style="width:10%;">Quantity</th>
                                <th style="width:10%;">Square Meter</th>
                                <th style="width:7%;">Pallets</th>
                                <th style="width:8%;">Unit Wt (kg)</th>
                                <th style="width:8%;">Net Wt (kg)</th>
                                <th style="width:9%;">Gross Wt (kg)</th>
                            </tr>
                        <% } else { %>
                            <tr class="header center">
                                <th style="width:5%;">Sr.</th>
                                <th style="width:22%;">Product Name</th>
                                <th style="width:13%;">Container</th>
                                <th style="width:10%;">HSN Code</th>
                                <th style="width:8%;">Unit</th>
                                <th style="width:10%;">Quantity</th>
                                <th style="width:10%;">Unit Wt (kg)</th>
                                <th style="width:10%;">Net Wt (kg)</th>
                                <th style="width:10%;">Gross Wt (kg)</th>
                            </tr>
                        <% } %>
                    </thead>
                    <tbody>
                        <% let totalQuantity = 0, totalUnitWt = 0, totalNetWt = 0, totalGrossWt = 0, totalVolume = 0; %>
                        
                        <% let globalProductIndex = 1; %>
                        <% if (allContainers.length > 0) { %>
                            <% allContainers.forEach((containerData, containerIndex) => { %>
                                <% const items = containerData && containerData.products ? containerData.products : []; %>
                                <% const containerName = containerData?.containerNumber || `Container ${containerIndex + 1}`; %>
                                <% const sealInfo = containerData?.sealType && containerData?.sealNumber ? `${containerData.sealType} - ${containerData.sealNumber}` : ''; %>
                                
                                <% if (items.length > 0) { %>
                                    <% items.forEach((p, productIndex) => { %>
                                        <% 
                                            const baseName = p.productName || p.productDescription || p.description || '-';
                                            // Get packaging data from packing list structure
                                            const packagingData = p.productData?.product?.packagingHierarchyData?.dynamicFields || {};
                                            const pcsPerPack = packagingData.PiecesPerPack || 0;
                                            const packsPerBox = packagingData.PackPerBox || 0;
                                            const totalPcsPerBox = pcsPerPack * packsPerBox;
                                            
                                            // Get dynamic unit names
                                            const pieceUnit = packagingData.PieceUnit || p.productData?.product?.packagingHierarchyData?.pieceUnit || 'pcs';
                                            const packUnit = packagingData.PackUnit || p.productData?.product?.packagingHierarchyData?.packUnit || 'pack';
                                            const boxUnit = packagingData.BoxUnit || p.productData?.product?.packagingHierarchyData?.boxUnit || 'box';
                                            
                                            let packingDescription = '';
                                            if (pcsPerPack > 0 && packsPerBox > 0) {
                                                packingDescription = `${pcsPerPack}${pieceUnit}*${packsPerBox}${packUnit} = ${totalPcsPerBox} ${pieceUnit}/${boxUnit}`;
                                            }
                                        %>
                                        <% 
                                            const tilesUnits = ['sqm', 'sqft', 'square meter'];
                                            const isTilesProduct = tilesUnits.includes(p.unit?.toLowerCase()) && 
                                                                  ((p.noOfBoxes && p.noOfBoxes > 0) || (p.noOfPallets && p.noOfPallets > 0));
                                            const squareMeter = isTilesProduct ? (p.quantity || p.packedQuantity || 0) : 0;
                                            const pallets = isTilesProduct ? (p.noOfPallets || 0) : 0;
                                        %>
                                        <% const hsnCode = p.hsnCode || p.hsCode || '484047'; %>
                                        <% const unit = isTilesProduct ? 'Box' : (p.unit || 'Box'); %>
                                        <% const quantity = p.unit && p.unit.toLowerCase() === 'box' ? (p.packedQuantity || p.quantity || p.noOfBoxes || '-') : (p.noOfBoxes || '-'); %>
                                        <% const netWeight = Number(p.netWeight || 0); %>
                                        <% const grossWeight = Number(p.grossWeight || 0); %>
                                        <% const volume = Number(p.measurement || 0); %>
                                        <% const boxes = Number(p.noOfBoxes || (p.unit && p.unit.toLowerCase() === 'box' ? (p.packedQuantity || p.quantity) : 0)); %>
                                        <% const unitWeight = boxes > 0 && netWeight > 0 ? (netWeight / boxes) : 0; %>
                                        
                                        <% totalQuantity += boxes; %>
                                        <% totalNetWt += netWeight; %>
                                        <% totalGrossWt += grossWeight; %>
                                        <% totalVolume += volume; %>
                                        <tr>
                                            <td class="center"><%= globalProductIndex++ %></td>
                                            <td>
                                                <div><%= baseName %></div>
                                                <% if (packingDescription) { %>
                                                    <div style="font-size: 9px; color: #000; margin-top: 2px;"><%= packingDescription %></div>
                                                <% } %>
                                            </td>
                                            <% if (productIndex === 0) { %>
                                                <td rowspan="<%= items.length %>" class="center" style="vertical-align: middle;">
                                                    <div class="bold" style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%;">
                                                        <div><%= containerName %></div>
                                                        <% if (sealInfo) { %>
                                                            <div style="font-size: 9px; color: #666; margin-top: 2px;"><%= sealInfo %></div>
                                                        <% } %>
                                                    </div>
                                                </td>
                                            <% } %>
                                            <td class="center"><%= hsnCode %></td>
                                            <td class="center"><%= unit %></td>
                                            <td class="right"><%= quantity %></td>
                                            <% if (hasTilesProducts) { %>
                                                <td class="right"><%= isTilesProduct && squareMeter > 0 ? squareMeter : '-' %></td>
                                                <td class="right"><%= isTilesProduct && pallets > 0 ? pallets : '-' %></td>
                                            <% } %>
                                            <td class="right"><%= unitWeight > 0 ? unitWeight.toFixed(2) : '-' %></td>
                                            <td class="right"><%= netWeight > 0 ? netWeight.toFixed(2) : '-' %></td>
                                            <td class="right"><%= grossWeight > 0 ? grossWeight.toFixed(2) : '-' %></td>
                                        </tr>
                                    <% }); %>
                                <% } else { %>
                                    <% const boxes = Number(containerData?.totalNoOfBoxes || 0); %>
                                    <% const netWeight = Number(containerData?.totalNetWeight || 0); %>
                                    <% const grossWeight = Number(containerData?.totalGrossWeight || 0); %>
                                    <% const volume = Number(containerData?.totalMeasurement || 0); %>
                                    <% const unitWeight = boxes > 0 && netWeight > 0 ? (netWeight / boxes) : 0; %>
                                    
                                    <% totalQuantity += boxes; %>
                                    <% totalNetWt += netWeight; %>
                                    <% totalGrossWt += grossWeight; %>
                                    <% totalVolume += volume; %>
                                    
                                    <tr>
                                        <td class="center"><%= globalProductIndex++ %></td>
                                        <td>-</td>
                                        <td class="center" style="vertical-align: middle;">
                                            <div class="bold" style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%;">
                                                <div><%= containerName %></div>
                                                <% if (sealInfo) { %>
                                                    <div style="font-size: 9px; color: #666; margin-top: 2px;"><%= sealInfo %></div>
                                                <% } %>
                                            </div>
                                        </td>
                                        <td class="center">-</td>
                                        <td class="center">-</td>
                                        <td class="right"><%= boxes || '-' %></td>
                                        <td class="right"><%= unitWeight > 0 ? unitWeight.toFixed(2) : '-' %></td>
                                        <td class="right"><%= netWeight > 0 ? netWeight.toFixed(2) : '-' %></td>
                                        <td class="right"><%= grossWeight > 0 ? grossWeight.toFixed(2) : '-' %></td>
                                        <!-- <td class="right"><%= volume > 0 ? volume.toFixed(4) : '-' %></td> -->
                                    </tr>
                                <% } %>
                            <% }); %>
                        <% } else { %>
                            <% const items = piInvoice.products || []; %>
                            <% items.forEach((p, i) => { %>
                                <% 
                                    const baseName = p.productName || p.productDescription || p.description || '-';
                                    // Try multiple possible field names for packaging data
                                    const pcsPerPack = p.pcsPerPack || p.piecePerPack || p.pcs_per_pack || p.piece_per_pack || p.piecesPerPack || p.packingDetails?.pcsPerPack || 0;
                                    const packsPerBox = p.packsPerBox || p.packPerBox || p.packs_per_box || p.pack_per_box || p.packsPerBox || p.packingDetails?.packsPerBox || 0;
                                    const totalPcsPerBox = pcsPerPack * packsPerBox;
                                    
                                    let packingDescription = '';
                                    if (pcsPerPack > 0 && packsPerBox > 0) {
                                        packingDescription = `${pcsPerPack}pcs/pack, ${pcsPerPack}pcs*${packsPerBox}pack = ${totalPcsPerBox} pcs/box`;
                                    } else if (pcsPerPack > 0) {
                                        // Show only pcs per pack if available
                                        packingDescription = `${pcsPerPack}pcs/pack`;
                                    } else {
                                        // Fallback: try to construct from available quantity data
                                        const qty = p.quantity || p.packedQuantity || 0;
                                        const boxes = p.noOfBoxes || 0;
                                        if (qty > 0 && boxes > 0) {
                                            const pcsPerBoxCalc = Math.round(qty / boxes);
                                            packingDescription = `${pcsPerBoxCalc} pcs/box`;
                                        }
                                    }
                                    // Debug: show what values we found
                                    if (!packingDescription) {
                                        packingDescription = `DEBUG: pcsPerPack=${pcsPerPack}, packsPerBox=${packsPerBox}`;
                                    }
                                %>
                                <% const hsnCode = p.hsnCode || p.hsCode || (p.category?.hsnCode) || (p.product?.category?.hsnCode) || '484047'; %>
                                <% const unit = p.unit || 'Box'; %>
                                <% const quantity = p.unit && p.unit.toLowerCase() === 'box' ? (p.packedQuantity || p.quantity || p.noOfBoxes || '-') : (p.noOfBoxes || '-'); %>
                                <% const netWeight = Number(p.netWeight || 0); %>
                                <% const grossWeight = Number(p.grossWeight || 0); %>
                                <% const volume = Number(p.measurement || 0); %>
                                <% const boxes = Number(p.noOfBoxes || (p.unit && p.unit.toLowerCase() === 'box' ? (p.packedQuantity || p.quantity) : 0)); %>
                                <% const unitWeight = boxes > 0 && netWeight > 0 ? (netWeight / boxes) : 0; %>
                                <% const containerName = piInvoice.packingLists?.[0]?.containerNumber || 'Container 1'; %>
                                <% const sealInfo = piInvoice.packingLists?.[0]?.sealType && piInvoice.packingLists?.[0]?.sealNumber ? `${piInvoice.packingLists[0].sealType} - ${piInvoice.packingLists[0].sealNumber}` : ''; %>
                                
                                <% totalQuantity += boxes; %>
                                <% totalNetWt += netWeight; %>
                                <% totalGrossWt += grossWeight; %>
                                <% totalVolume += volume; %>
                                
                                <tr>
                                    <td class="center"><%= globalProductIndex++ %></td>
                                    <td>
                                        <div><%= baseName %></div>
                                        <% if (packingDescription) { %>
                                            <div style="font-size: 9px; color: #666; margin-top: 2px;"><%= packingDescription %></div>
                                        <% } %>
                                    </td>
                                    <td class="center" style="vertical-align: middle;">
                                        <% if (i === 0) { %>
                                            <div class="bold" style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%;">
                                                <div><%= containerName %></div>
                                                <% if (sealInfo) { %>
                                                    <div style="font-size: 9px; color: #666; margin-top: 2px;"><%= sealInfo %></div>
                                                <% } %>
                                            </div>
                                        <% } else { %>
                                            -
                                        <% } %>
                                    </td>
                                    <td class="center"><%= hsnCode %></td>
                                    <td class="center"><%= unit %></td>
                                    <td class="right"><%= quantity %></td>
                                    <td class="right"><%= unitWeight > 0 ? unitWeight.toFixed(2) : '-' %></td>
                                    <td class="right"><%= netWeight > 0 ? netWeight.toFixed(2) : '-' %></td>
                                    <td class="right"><%= grossWeight > 0 ? grossWeight.toFixed(2) : '-' %></td>
                                    <!-- <td class="right"><%= volume > 0 ? volume.toFixed(4) : '-' %></td> -->
                                </tr>
                            <% }); %>
                        <% } %>

                        <% 
                            // Calculate totals for tiles products
                            let totalSquareMeters = 0, totalPallets = 0;
                            if (allContainers.length > 0) {
                                allContainers.forEach(containerData => {
                                    const items = containerData && containerData.products ? containerData.products : [];
                                    items.forEach(p => {
                                        const tilesUnits = ['sqm', 'sqft', 'square meter'];
                                        const isTilesProduct = tilesUnits.includes(p.unit?.toLowerCase()) && 
                                                              ((p.noOfBoxes && p.noOfBoxes > 0) || (p.noOfPallets && p.noOfPallets > 0));
                                        if (isTilesProduct) {
                                            totalSquareMeters += Number(p.quantity || p.packedQuantity || 0);
                                            totalPallets += Number(p.noOfPallets || 0);
                                        }
                                    });
                                });
                            } else {
                                const items = piInvoice.products || [];
                                items.forEach(p => {
                                    const tilesUnits = ['sqm', 'sqft', 'square meter'];
                                    const isTilesProduct = tilesUnits.includes(p.unit?.toLowerCase()) && 
                                                          ((p.calculatedBoxes && p.calculatedBoxes > 0) || (p.calculatedPallets && p.calculatedPallets > 0));
                                    if (isTilesProduct) {
                                        totalSquareMeters += Number(p.quantity || p.packedQuantity || 0);
                                        totalPallets += Number(p.calculatedPallets || p.noOfPallets || 0);
                                    }
                                });
                            }
                        %>
                        <!-- TOTAL row -->
                        <% if (hasTilesProducts) { %>
                            <tr class="bold header">
                                <td colspan="5" class="center">TOTAL</td>
                                <td class="right"><%= totalQuantity || 0 %></td>
                                <td class="right"><%= totalSquareMeters > 0 ? totalSquareMeters.toFixed(1) : '0' %></td>
                                <td class="right"><%= totalPallets || 0 %></td>
                                <td class="right"><%= totalQuantity > 0 && totalNetWt > 0 ? (totalNetWt / totalQuantity).toFixed(2) : '-' %></td>
                                <td class="right"><%= totalNetWt ? totalNetWt.toFixed(0) : '0' %></td>
                                <td class="right"><%= totalGrossWt ? totalGrossWt.toFixed(0) : '0' %></td>
                            </tr>
                        <% } else { %>
                            <tr class="bold header">
                                <td colspan="5" class="center">TOTAL</td>
                                <td class="right"><%= totalQuantity || 0 %></td>
                                <td class="right"><%= totalQuantity > 0 && totalNetWt > 0 ? (totalNetWt / totalQuantity).toFixed(2) : '-' %></td>
                                <td class="right"><%= totalNetWt ? totalNetWt.toFixed(2) : '0' %></td>
                                <td class="right"><%= totalGrossWt ? totalGrossWt.toFixed(2) : '0' %></td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>



                <!-- Footer section matching the image layout -->
                <table style="margin-top: 20px;">
                    <tr>
                        <td colspan="2" class="header">REMARKS:-</td>
                    </tr>
                    <tr>
                        <td colspan="2" style="height: 40px; vertical-align: top;">
                            <% if (packingListData.notes) { %>
                                <%= packingListData.notes %>
                                    <% } %>
                        </td>
                    </tr>
                    <tr>
                        <td style="width: 70%; padding: 10px; vertical-align: top;">
                            <div style="margin-bottom: 15px;">
                                <strong>Merchandise to be of <%= packingListData.countryOfOrigin || 'India' %>
                                        Origin.</strong>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>Declaration:</strong>
                            </div>
                            <div>
                                We Declare that this Invoice shows the Actual prices of the goods described and that
                                particulars are true and correct.
                            </div>
                        </td>
                        <td style="width: 30%; text-align: center; vertical-align: top; padding: 10px;">
                            <div style="margin-bottom: 10px;">
                                <strong>For, <%= piInvoice.company?.name || 'ANANTA INC.' %></strong>
                            </div>
                            <div style="height: 80px; display: flex; align-items: center; justify-content: center;">
                                <% const signatureUrl = piInvoice.company?.signature; %>
                                <% const fullSignatureUrl = signatureUrl ? (signatureUrl.startsWith('http') ? signatureUrl : `http://localhost:8000${signatureUrl}`) : null; %>
                                <% if (typeof signatureBase64 !== 'undefined' && signatureBase64) { %>
                                    <img src="data:image/*;base64,<%= signatureBase64 %>" alt="Signature" style="max-height: 60px; max-width: 120px; object-fit: contain;">
                                <% } else if (fullSignatureUrl) { %>
                                    <img src="<%= fullSignatureUrl %>" alt="Signature" style="max-height: 60px; max-width: 120px; object-fit: contain;">
                                <% } %>
                            </div>
                            <div style="margin-top: 10px;">
                                <div style="border-bottom: 1px solid #000; width: 120px; margin: 0 auto;"></div>
                                <div style="font-size: 9px; margin-top: 2px;">Authorised Signatory</div>
                            </div>
                        </td>
                    </tr>
                </table>
    </div>

</body>

</html>