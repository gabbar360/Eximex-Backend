<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Proforma Invoice</title>
    <style>
        :root {
            --outer: 2px solid #000;
            --inner: 1px solid #000;
            --grey: #e0e0e0;
        }

        body {
            font-family: Arial, sans-serif;
            font-size: 10px;
            margin: 10px;
        }

        .page {
            border: var(--outer);
        }

        .title {
            background: var(--grey);
            text-align: center;
            font-weight: 700;
            font-size: 16px;
            padding: 6px 8px;
            border-bottom: var(--inner);
        }

        .subtitle {
            text-align: center;
            padding: 6px 8px;
            border-bottom: var(--inner);
            font-size: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            border: var(--inner);
            padding: 6px;
            vertical-align: top;
        }

        .header {
            background: var(--grey);
            font-weight: bold;
        }

        .center {
            text-align: center;
        }

        .right {
            text-align: right;
        }

        .bold {
            font-weight: bold;
        }

        .table-title {
            text-align: center;
            border-left: var(--inner);
            border-right: var(--inner);
            border-bottom: var(--inner);
            background: var(--grey);
            padding: 6px 4px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="page">
        <div class="title">PROFORMA INVOICE</div>
        <div class="subtitle">SUPPLY MEANT FOR EXPORT UNDER BOND & LUT - LETTER OF UNDERTAKING WITHOUT PAYMENT OF INTEGRATED TAX</div>

        <table>
            <tr>
                <td rowspan="3" style="width: 60%;">
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <div style="flex: 1;">
                            <div class="bold" style="text-decoration: underline;">EXPORTER:</div>
                            <div class="bold" style="margin-top: 4px; font-size: 12px;">
                                <%= piInvoice.company?.name || 'COMPANY NAME' %>
                            </div>
                            <div><%= piInvoice.company?.address || 'Company Address' %></div>
                            <div>
                                <%= piInvoice.company.city || '' %>
                                <%= piInvoice.company.state ? ', ' + piInvoice.company.state : '' %>
                                <%= piInvoice.company.pincode ? ', ' + piInvoice.company.pincode : '' %>
                            </div>
                            <div>Phone: <%= piInvoice.company.phoneNo || '+91-XXXXXXXXXX' %></div>
                            <div>Email: <%= piInvoice.company.email || 'email@company.com' %></div>
                        </div>
                        <div style="text-align:right;">
                            <% const logoUrl=piInvoice.company?.logo; %>
                            <% const fullLogoUrl=logoUrl ? (logoUrl.startsWith('http') ? logoUrl : `http://localhost:8000${logoUrl}`) : null; %>
                            <% if (typeof logoBase64 !=='undefined' && logoBase64) { %>
                                <img src="data:image/*;base64,<%= logoBase64 %>" alt="Company Logo" style="max-height: 80px; max-width: 200px; object-fit: contain; border-radius: 8px; border: none; padding: 4px;">
                            <% } else if (fullLogoUrl) { %>
                                <img src="<%= fullLogoUrl %>" alt="Company Logo" style="max-height: 80px; max-width: 200px; object-fit: contain; border-radius: 8px; border: none; padding: 4px;">
                            <% } %>
                        </div>
                    </div>
                </td>
                <td style="width: 20%;" class="center">
                    <div class="bold">Invoice No:</div>
                    <div class="bold" style="font-size: 12px; margin-top: 2px;">
                        <%= piInvoice.piNumber %>
                    </div>
                </td>
                <td style="width: 20%;" class="center">
                    <div class="bold">Date:</div>
                    <div class="bold" style="font-size: 12px; margin-top: 2px;">
                        <%= new Date(piInvoice.invoiceDate || piInvoice.createdAt).toLocaleDateString('en-GB', { day:'2-digit', month:'long', year:'numeric' }) %>
                    </div>
                </td>
            </tr>
            <tr>
                <td colspan="2" class="bold">Buyer's Ref No. & Date :-</td>
            </tr>
            <tr>
                <td colspan="2">
                    <div class="bold">Terms & Conditions :-</div>
                    <ol style="margin: 4px 0 0 16px; padding: 0;">
                        <% if (piInvoice.deliveryTerm) { %>
                            <li>TRADE TERM: <%= piInvoice.deliveryTerm %></li>
                        <% } %>
                        <% if (piInvoice.paymentTerm) { %>
                            <li>PAYMENT TERM: <%= piInvoice.paymentTerm %></li>
                        <% } %>
                    </ol>
                </td>
            </tr>
        </table>

        <table>
            <tr>
                <td class="header">CONSIGNEE:</td>
                <td class="header">BUYER</td>
                <td class="header">NOTIFY PARTY (Other then Buyer)</td>
            </tr>
            <tr>
                <td style="width: 40%;">
                    <div class="bold" style="margin-top:2px;">
                        <%= piInvoice.partyName || piInvoice.party?.companyName || '-' %>
                    </div>
                    <div>Address: <%= piInvoice.address || piInvoice.party?.address || '' %></div>
                    <div><%= piInvoice.country || piInvoice.party?.country || '' %></div>
                    <% if (piInvoice.phone || piInvoice.party?.phone) { %>
                        <div>Phone: <%= piInvoice.phone || piInvoice.party?.phone %></div>
                    <% } %>
                    <% if (piInvoice.email || piInvoice.party?.email) { %>
                        <div>Email: <%= piInvoice.email || piInvoice.party?.email %></div>
                    <% } %>
                </td>
                <td style="width: 40%;">
                    <div class="bold" style="margin-top:2px;">
                        <%= piInvoice.partyName || piInvoice.party?.companyName || 'N/A' %>
                    </div>
                    <div>Address: <%= piInvoice.address || piInvoice.party?.address || '' %></div>
                    <% if (piInvoice.phone || piInvoice.party?.phone) { %>
                        <div>Phone: <%= piInvoice.phone || piInvoice.party?.phone %></div>
                    <% } %>
                    <% if (piInvoice.email || piInvoice.party?.email) { %>
                        <div>Email: <%= piInvoice.email || piInvoice.party?.email %></div>
                    <% } %>
                </td>
                <td style="width: 20%;"></td>
            </tr>
        </table>

        <table>
            <tr class="center header">
                <td>Pre Carriage By</td>
                <td>Place of Receipt by Pre-Carrier</td>
                <td>Country of Origin of Goods</td>
                <td>Country of Final Destination</td>
            </tr>
            <tr class="center">
                <td><%= piInvoice.preCarriageBy || '-' %></td>
                <td><%= piInvoice.placeOfReceipt || '-' %></td>
                <td><%= piInvoice.countryOfOrigin || 'INDIA' %></td>
                <td><%= piInvoice.countryOfDestination || piInvoice.country || '-' %></td>
            </tr>
            <tr class="center header">
                <td>Vessel/ Flight No</td>
                <td>Port of Loading</td>
                <td>Port of Discharge</td>
                <td>Final Destination</td>
            </tr>
            <tr class="center">
                <td><%= piInvoice.vesselFlightNo || '-' %></td>
                <td><%= piInvoice.portOfLoading || '-' %></td>
                <td><%= piInvoice.portOfDischarge || '-' %></td>
                <td><%= piInvoice.finalDestination || '-' %></td>
            </tr>
        </table>

        <div class="table-title">Description of Goods</div>
        <table>
            <thead>
                <tr class="header center">
                    <th style="width: 4%;">S.No.</th>
                    <th style="width: 40%;">Description of Goods</th>
                    <th style="width: 8%;">HS Code</th>
                    <th style="width: 10%;">Quantity</th>
                    <th style="width: 6%;">Unit</th>
                    <th style="width: 10%;">Rate USD</th>
                    <th style="width: 10%;">Weight (Kgs)</th>
                    <th style="width: 12%;">Amount USD</th>
                </tr>
            </thead>
            <tbody>
                <% let sumAmount=0, totalNet=0, totalGross=0; %>
                <% piInvoice.products.forEach((product, index) => { %>
                    <% const lineAmt = Number(product.total || 0) || 0; %>
                    <% const net = product.totalWeight ? (parseFloat(product.totalWeight) * 0.9) : 0; %>
                    <% const gross = product.totalWeight ? parseFloat(product.totalWeight) : 0; %>
                    <% sumAmount += lineAmt; totalNet += net; totalGross += gross; %>
                    <tr>
                        <td class="center"><%= index + 1 %></td>
                        <td>
                            <strong><%= product.productName || '-' %></strong>
                            <% if (product.productDescription && product.productDescription !== product.productName) { %>
                                <br><%= product.productDescription %>
                            <% } %>
                        </td>
                        <td class="center"><%= product.hsCode || product.hsnCode || product.category?.hsnCode || product.product?.category?.hsnCode || '' %></td>
                        <td class="right"><%= product.quantity || 0 %></td>
                        <td class="center"><%= product.unit || 'PCS' %></td>
                        <td class="right"><%= (product.rate || 0) %></td>
                        <td class="right"><%= gross ? gross.toFixed(0) + 'kg' : '0kg' %></td>
                        <td class="right">$ <%= (product.total || 0).toFixed(2) %></td>
                    </tr>
                <% }) %>
                <tr class="bold header">
                    <td colspan="6" class="center">SUB TOTAL</td>
                    <td></td>
                    <td class="right">$ <%= sumAmount.toFixed(2) %></td>
                </tr>
            </tbody>
        </table>

        <% let charges = 0; %>
        <% if (piInvoice.charges) { %>
            <% Object.entries(piInvoice.charges).forEach(([key, value]) => { %>
                <% if (key === 'otherCharges' && Array.isArray(value)) { %>
                    <% value.forEach((charge) => { charges += parseFloat(charge.amount || 0); }); %>
                <% } else if (key !== 'noOtherCharges') { %>
                    <% charges += parseFloat(value || 0); %>
                <% } %>
            <% }); %>
        <% } %>
        <% const totalAmount = sumAmount + charges; %>

        <table>
            <tr>
                <td style="width: 70%;">
                    <div class="bold">AMOUNT IN WORDS (USD) :-</div>
                    <% 
                        const finalAmount = piInvoice.totalAmount || totalAmount;
                        function numberToWords(num) {
                            const ones = ['', 'ONE', 'TWO', 'THREE', 'FOUR', 'FIVE', 'SIX', 'SEVEN', 'EIGHT', 'NINE', 'TEN', 'ELEVEN', 'TWELVE', 'THIRTEEN', 'FOURTEEN', 'FIFTEEN', 'SIXTEEN', 'SEVENTEEN', 'EIGHTEEN', 'NINETEEN'];
                            const tens = ['', '', 'TWENTY', 'THIRTY', 'FORTY', 'FIFTY', 'SIXTY', 'SEVENTY', 'EIGHTY', 'NINETY'];
                            
                            if (num === 0) return 'ZERO';
                            if (num < 20) return ones[num];
                            if (num < 100) return tens[Math.floor(num/10)] + (num%10 ? ' ' + ones[num%10] : '');
                            if (num < 1000) return ones[Math.floor(num/100)] + ' HUNDRED' + (num%100 ? ' ' + numberToWords(num%100) : '');
                            if (num < 1000000) return numberToWords(Math.floor(num/1000)) + ' THOUSAND' + (num%1000 ? ' ' + numberToWords(num%1000) : '');
                            return numberToWords(Math.floor(num/1000000)) + ' MILLION' + (num%1000000 ? ' ' + numberToWords(num%1000000) : '');
                        }
                        const amountInWords = finalAmount ? numberToWords(Math.floor(finalAmount)) + ' DOLLARS ONLY' : '';
                    %>
                    <%= amountInWords %>
                </td>
                <td style="width: 30%;">
                    <table style="width:100%; border-collapse:collapse;">
                        <% if (piInvoice.charges && Object.keys(piInvoice.charges).length > 0) { %>
                            <% Object.entries(piInvoice.charges).forEach(([key, value]) => { %>
                                <% if (key === 'otherCharges' && Array.isArray(value)) { %>
                                    <% value.forEach((charge) => { %>
                                        <tr>
                                            <td style="border: var(--inner); padding:8px 6px; font-weight:bold;">
                                                <%= charge.name.toUpperCase() %>:-
                                            </td>
                                            <td class="right" style="border: var(--inner); padding:8px 6px; font-weight:bold;">
                                                <%= charge.amount && !isNaN(parseFloat(charge.amount)) ? '$' + parseFloat(charge.amount).toFixed(2) : '-' %>
                                            </td>
                                        </tr>
                                    <% }) %>
                                <% } else { %>
                                    <tr>
                                        <td style="border: var(--inner); padding:8px 6px; font-weight:bold;">
                                            <%= key.toUpperCase() %>:-
                                        </td>
                                        <td class="right" style="border: var(--inner); padding:8px 6px; font-weight:bold;">
                                            <%= value && !isNaN(parseFloat(value)) ? '$' + parseFloat(value).toFixed(2) : '-' %>
                                        </td>
                                    </tr>
                                <% } %>
                            <% }) %>
                        <% } %>
                        <tr>
                            <td style="border: var(--inner); padding:8px 6px; font-weight:bold;">TOTAL AMOUNT:-</td>
                            <td class="right" style="border: var(--inner); padding:8px 6px; font-weight:bold;">
                                $ <%= (piInvoice.totalAmount || totalAmount).toFixed(2) %>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>

        <table>
            <tr>
                <td class="header" colspan="2">BANK DETAILS :-</td>
            </tr>
            <tr>
                <td style="width: 70%; padding: 10px; vertical-align: top;">
                    <div style="font-size: 10px; margin-bottom: 2px;"><strong>BANK NAME :-</strong> <%= piInvoice.company.bankName || 'N/A' %></div>
                    <div style="font-size: 10px; margin-bottom: 2px;"><strong>BANK ADDRESS :-</strong> <%= piInvoice.company.bankAddress || '' %></div>
                    <div style="font-size: 10px; margin-bottom: 2px;"><strong>ACCOUNT NUMBER :-</strong> <%= piInvoice.company.accountNumber || 'N/A' %></div>
                    <div style="font-size: 10px; margin-bottom: 2px;"><strong>IFSC CODE :-</strong> <%= piInvoice.company.ifscCode || 'N/A' %></div>
                    <div style="font-size: 10px;"><strong>SWIFT CODE :-</strong> <%= piInvoice.company.swiftCode || 'N/A' %></div>
                </td>
                <td style="width: 30%; text-align: center; vertical-align: top; padding: 10px;">
                    <div style="margin-bottom: 10px;">
                        <strong>For, <%= piInvoice.company?.name || 'COMPANY NAME' %></strong>
                    </div>
                    <div style="height: 80px; display: flex; align-items: center; justify-content: center;">
                        <div style="width: 100px; height: 100px; border: 1px dashed #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 8px; color: #999;">
                            COMPANY<br>SEAL
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <div style="border-bottom: 1px solid #000; width: 120px; margin: 0 auto;"></div>
                        <div style="font-size: 9px; margin-top: 2px;">Authorised Signatory</div>
                    </div>
                </td>
            </tr>
        </table>

        <table style="margin-top: 20px;">
            <tr>
                <td style="padding: 10px; vertical-align: top;">
                    <div style="margin-bottom: 15px;">
                        <strong>Merchandise to be of India Origin.</strong>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>Declaration:</strong>
                    </div>
                    <div>
                        We Declare that this Invoice shows the Actual prices of the goods described and that particulars are true and correct.
                    </div>
                </td>
            </tr>
        </table>
    </div>
</body>

</html>